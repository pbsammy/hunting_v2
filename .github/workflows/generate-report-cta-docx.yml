name: Generate Threat Hunt Report (CTA DOCX)

on:
  workflow_dispatch:
    inputs:
      hunt_prompt:
        description: "Threat hunt prompt"
        required: true
        type: string
      prepared_by:
        description: "Prepared by (defaults to Shawn McWhirter)"
        required: false
        type: string
      model:
        description: "Model name"
        required: false
        type: string
        default: "gemini-2.5-flash"

jobs:
  generate-report-cta-docx:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-docx google-genai

      - name: Ensure output folder
        run: mkdir -p output

      - name: Generate CTA-styled DOCX
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e
          SYS_PROMPT="prompts/hunt_system_prompt.txt"
          TEMPLATE="templates/cta/CTA_THREAT_HUNT_Integrated.docx"
          OUT_DOCX="output/CTA_THREAT_HUNT_${{ github.run_id }}.docx"
          PREP_BY="${{ github.event.inputs.prepared_by }}"
          if [ -z "$PREP_BY" ]; then PREP_BY="Shawn McWhirter"; fi

          python app/main_ai_studio_docx.py \
            --system-file "$SYS_PROMPT" \
            --template "$TEMPLATE" \
            --prompt "${{ github.event.inputs.hunt_prompt }}" \
            --prepared-by "$PREP_BY" \
            --model "${{ github.event.inputs.model }}" \
            --output "$OUT_DOCX"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: CTA_THREAT_HUNT_DOCX
          path: output/*.docx
