name: Generate Threat Hunt Report

on:
  workflow_dispatch:  # manual trigger
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    # Uncomment if you use environment-scoped secrets:
    # environment: prod

    steps:
      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3) Install dependencies (pin google-genai >= 1.62.0)
      #    If you already have requirements.txt, we append/override google-genai.
      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            # Ensure we install a fixed SDK or newer
            sed -i '/^google-genai/d' requirements.txt || true
            echo 'google-genai>=1.62.0' >> requirements.txt
            pip install -r requirements.txt
          else
            pip install "google-genai>=1.62.0"
          fi

      # 4) Preflight: verify actual prompt file (root-level hunt_system_prompt.txt)
      - name: Preflight - verify inputs
        shell: bash
        run: |
          test -f hunt_system_prompt.txt || { echo "::error title=Missing prompt::hunt_system_prompt.txt not found"; exit 1; }
          # Optional attachments (don’t fail hard): create placeholders if needed
          mkdir -p output
          [[ -f output/logs.txt ]] || echo "No logs available." > output/logs.txt
          [[ -f output/findings.json ]] || echo "{}" > output/findings.json

      # 5) Run the report generator with the inline workaround
      - name: Run report generator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_INLINE_SYSTEM: "1"   # ← enable inline fallback (remove after SDK upgrade is verified)
        run: |
          python app/main_ai_studio.py \
            --prompt-file hunt_system_prompt.txt \
            --attach output/logs.txt output/findings.json \
            --no-stream \
            --output output/threat_hunt_report.md

      # 6) Upload the generated artifact (uses the supported v4 action)
      - name: Upload Threat Hunt Report artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report
          path: |
            output/threat_hunt_report.md
          retention-days: 30  # adjust as needed
