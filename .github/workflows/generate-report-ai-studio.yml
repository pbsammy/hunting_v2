name: Generate Threat Hunt Report (AI Studio DOCX)

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional). Examples: gemini-2.5-flash, gemini-1.5-pro-002"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-docx-report:
    runs-on: ubuntu-latest

    env:
      # Use workflow_dispatch inputs when provided; otherwise default to a safe, current model.
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-2.5-flash' }}

      # Paths (DOCX template required)
      TEMPLATE_PATH: templates/cta/CTA-reference.docx
      SYSTEM_FILE: prompts/hunt_system_prompt.txt
      PROMPT_FILE: prompts/hunt_user_prompt.md
      OUTPUT_PATH: output/threat_hunt_report.docx

      # Attribution
      PREPARED_BY: "McWhirter, Shawn [USA]"

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Resolve IDEA for push events
      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            echo "IDEA already set from env."
          fi

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 4) Install Python dependencies from requirements.txt
      - name: Install Python deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Import checks (YAML-safe one-liners; no heredocs)
          python -c "import docx; print('OK: python-docx import')"
          python -c "import jinja2; print('OK: Jinja2 import')"
          # Optional: if you have Markdown in requirements.txt
          python -c "import markdown; print('OK: Markdown import')" || true
          # Version prints (optional)
          python -c "import importlib.metadata as m; print('python-docx:', m.version('python-docx'))"
          python -c "import importlib.metadata as m; print('Jinja2:', m.version('Jinja2'))"
          python -c "import importlib.metadata as m; print('google-genai:', m.version('google-genai'))"

      # 5) Pre-flight: validate inputs, paths, and GEMINI_API_KEY secret
      - name: Validate inputs and paths
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          SYSTEM_FILE: ${{ env.SYSTEM_FILE }}
          PROMPT_FILE: ${{ env.PROMPT_FILE }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail
          [ -n "${IDEA:-}" ] || { echo "IDEA is empty; set via workflow_dispatch or commit message 'idea:'"; exit 1; }
          [ -f "$TEMPLATE_PATH" ] || { echo "Template missing (DOCX required): $TEMPLATE_PATH"; exit 1; }
          [ -f "$SYSTEM_FILE" ] || { echo "System prompt missing: $SYSTEM_FILE"; exit 1; }
          [ -f "$PROMPT_FILE" ] || { echo "User prompt missing: $PROMPT_FILE"; exit 1; }
          [ -n "${GEMINI_API_KEY:-}" ] || { echo "ERROR: GEMINI_API_KEY secret is not set (Repo Settings → Secrets → Actions)"; exit 1; }
          echo "Pre-flight OK"

      # 6) Generate DOCX report (exact flags per your argparse)
      - name: Generate DOCX report (AI Studio)
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          MODEL: ${{ env.MODEL }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          SYSTEM_FILE: ${{ env.SYSTEM_FILE }}
          PROMPT_FILE: ${{ env.PROMPT_FILE }}
          OUTPUT_PATH: ${{ env.OUTPUT_PATH }}
          PREPARED_BY: ${{ env.PREPARED_BY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          echo "Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          echo "System file: ${SYSTEM_FILE}"
          echo "Template (DOCX): ${TEMPLATE_PATH}"
          echo "Prompt: ${PROMPT_FILE}"
          echo "Output: ${OUTPUT_PATH}"
          echo "Prepared by: ${PREPARED_BY}"

          python app/main_ai_studio_docx.py \
            --system-file "$SYSTEM_FILE" \
            --template "$TEMPLATE_PATH" \
            --prompt "$PROMPT_FILE" \
            --prepared-by "$PREPARED_BY" \
            --model "$MODEL" \
            --output "$OUTPUT_PATH"

          test -s "$OUTPUT_PATH" && echo "DOCX report generated: $OUTPUT_PATH"

      # 7) Upload artifact
      - name: Upload DOCX artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-docx
          path: ${{ env.OUTPUT_PATH }}
