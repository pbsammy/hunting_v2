name: Generate Threat Hunt Report (AI Studio DOCX)

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-docx-report:
    runs-on: ubuntu-latest

    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-1.5-pro-latest' }}
      TEMPLATE_PATH: templates/cta_hunt_report_template.md
      OUTPUT_PATH: output/threat_hunt_report.docx
      SYSTEM_PROMPT_PATH: prompts/hunt_system_prompt.txt
      USER_PROMPT_PATH: prompts/hunt_user_prompt.md

    steps:
      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Resolve IDEA for push events (parse "idea:" from commit message)
      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            echo "IDEA already set from env."
          fi

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 4) (Optional) Install system deps if your pipeline converts MD->DOCX via Pandoc
      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y pandoc || true

      # 5) Install Python dependencies (explicitly ensure python-docx is present)
      - name: Install Python deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "requirements.txt found; installing..."
            pip install -r requirements.txt
          fi

          # Ensure python-docx is installed even if requirements.txt missed it
          pip install --upgrade python-docx==1.1.2

          # (Optional) other libs commonly used by your app
          pip install --upgrade google-genai==1.64.0 Jinja2==3.1.4 || true

          # Verify installs; fail fast if missing
          python - <<'PY'
import sys
def check(mod):
    try:
        __import__(mod)
        print(f"OK: {mod} import succeeded")
    except Exception as e:
        print(f"ERROR: {mod} import failed: {e}")
        sys.exit(1)

check("docx")           # python-docx
check("jinja2")
PY

          # Show versions for traceability (non-fatal if not present)
          python - <<'PY'
import importlib.metadata as m
def version(name):
    try:
        print(name + ":", m.version(name))
    except Exception as e:
        print(name + " version lookup failed:", e)

version("python-docx")
version("Jinja2")
version("google-genai")
PY

      # 6) Pre-flight: validate expected inputs/paths
      - name: Validate inputs and paths
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          SYSTEM_PROMPT_PATH: ${{ env.SYSTEM_PROMPT_PATH }}
          USER_PROMPT_PATH: ${{ env.USER_PROMPT_PATH }}
        run: |
          set -euo pipefail
          [ -n "${IDEA:-}" ] || { echo "IDEA is empty; set via workflow_dispatch or commit message 'idea:'"; exit 1; }
          [ -f "$TEMPLATE_PATH" ] || { echo "Template missing: $TEMPLATE_PATH"; exit 1; }
          [ -f "$SYSTEM_PROMPT_PATH" ] || { echo "System prompt missing: $SYSTEM_PROMPT_PATH"; exit 1; }
          [ -f "$USER_PROMPT_PATH" ] || { echo "User prompt missing: $USER_PROMPT_PATH"; exit 1; }
          echo "Pre-flight OK"

      # 7) Run DOCX generator (AI Studio)
      - name: Generate DOCX report (AI Studio)
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          MODEL: ${{ env.MODEL }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          OUTPUT_PATH: ${{ env.OUTPUT_PATH }}
          SYSTEM_PROMPT_PATH: ${{ env.SYSTEM_PROMPT_PATH }}
          USER_PROMPT_PATH: ${{ env.USER_PROMPT_PATH }}
          GENAI_API_KEY: ${{ secrets.GENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          echo "Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          echo "Template: ${TEMPLATE_PATH}"
          echo "Output: ${OUTPUT_PATH}"

          # Try explicit flags first â€” adjust to your script's argparse if needed
          python app/main_ai_studio_docx.py \
            --idea "$IDEA" \
            --model "$MODEL" \
            --template "$TEMPLATE_PATH" \
            --system-prompt "$SYSTEM_PROMPT_PATH" \
            --user-prompt "$USER_PROMPT_PATH" \
            --output "$OUTPUT_PATH" \
          || {
            echo "Flagged invocation failed; retrying with env-only call..."
            IDEA="$IDEA" MODEL="$MODEL" TEMPLATE_PATH="$TEMPLATE_PATH" OUTPUT_PATH="$OUTPUT_PATH" \
            SYSTEM_PROMPT_PATH="$SYSTEM_PROMPT_PATH" USER_PROMPT_PATH="$USER_PROMPT_PATH" GENAI_API_KEY="$GENAI_API_KEY" \
            python app/main_ai_studio_docx.py
          }

          test -s "$OUTPUT_PATH" && echo "DOCX report generated: $OUTPUT_PATH"

      # 8) Upload artifact
      - name: Upload DOCX artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-docx
          path: ${{ env.OUTPUT_PATH }}
