name: Generate Threat Hunt Report

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-report:
    runs-on: ubuntu-latest

    # Use workflow_dispatch inputs only when that event fired; otherwise fall back to defaults
    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-1.5-pro-latest' }}

    steps:
      # (Optional) Catch YAML/Action issues early in CI
      - name: Lint workflow (actionlint)
        uses: rhysd/actionlint@v1

      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Resolve IDEA for push events (parse "idea:" from commit message)
      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          # If IDEA is empty (no workflow_dispatch inputs), parse commit message for a line starting with "idea:"
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            # Preserve the env IDEA established at job.env
            echo "IDEA already set from env."
          fi

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Install dependencies + show versions
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          # Pin versions explicitly for reproducibility; update as needed
          pip install google-genai==1.64.0 Jinja2==3.1.4
          python - <<'PY'
import importlib.metadata as m
print("google-genai:", m.version("google-genai"))
print("Jinja2:", m.version("Jinja2"))
PY

      # 5) Generate report using AI model
      - name: Generate report
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}            # Uses resolved IDEA from prior step (push) or job.env (dispatch)
          MODEL: ${{ env.MODEL }}
        run: |
          set -euo pipefail
          echo "Threat Hunt Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          # Example generation with a Python driver script; replace with your own logic
          python - <<'PY'
import os
from jinja2 import Template

idea = os.environ.get("IDEA", "").strip()
model = os.environ.get("MODEL", "gemini-1.5-pro-latest").strip()

if not idea:
    idea = "Hunting cadence run (no explicit idea provided)"

template = Template("""# Threat Hunt Report

**Idea:** {{ idea }}
**Model:** {{ model }}

## Objectives
- Validate signals associated with the idea.
- Enumerate data sources and relevant detections.
- Identify hypotheses, gaps, and next steps.

## Signals & Detections
- TBD based on telemetry and threat model.

## Findings
- TBD.

## Next Steps
- TBD.

Generated by CI on GitHub Actions.
""")

report = template.render(idea=idea, model=model)

os.makedirs("reports", exist_ok=True)
with open("reports/threat-hunt-report.md", "w", encoding="utf-8") as f:
    f.write(report)
print("Wrote reports/threat-hunt-report.md")
PY

      # 6) Upload artifact (optional, if you want to pull it from the run)
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report
          path: reports/threat-hunt-report.md
