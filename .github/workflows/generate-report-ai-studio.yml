name: Generate Threat Hunt Report (AI Studio DOCX)

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-docx-report:
    runs-on: ubuntu-latest

    # Use workflow_dispatch inputs only when that event fired; otherwise fall back to defaults
    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-1.5-pro-latest' }}
      TEMPLATE_PATH: templates/cta_hunt_report_template.md
      OUTPUT_PATH: output/threat_hunt_report.docx
      SYSTEM_PROMPT_PATH: prompts/hunt_system_prompt.txt
      USER_PROMPT_PATH: prompts/hunt_user_prompt.md

    steps:
      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Resolve IDEA for push events (parse "idea:" from commit message)
      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            echo "IDEA already set from env."
          fi

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Install system deps (optional; keep if your generator uses pandoc or docx conversions)
      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y pandoc || true

      # 5) Install Python dependencies
      - name: Install Python deps
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # Fallback pins; adjust to your actual needs
            pip install google-genai==1.64.0 Jinja2==3.1.4 python-docx==1.1.2
          fi
          python -c "import importlib.metadata as m; print('google-genai:', m.version('google-genai'))" || true
          python -c "import importlib.metadata as m; print('Jinja2:', m.version('Jinja2'))" || true
          python -c "import importlib.metadata as m; print('python-docx:', m.version('python-docx'))" || true

      # 6) Run DOCX generator (AI Studio)
      - name: Generate DOCX report (AI Studio)
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          MODEL: ${{ env.MODEL }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          OUTPUT_PATH: ${{ env.OUTPUT_PATH }}
          SYSTEM_PROMPT_PATH: ${{ env.SYSTEM_PROMPT_PATH }}
          USER_PROMPT_PATH: ${{ env.USER_PROMPT_PATH }}
          # Set your Google GenAI API key (or equivalent) in repo secrets
          GENAI_API_KEY: ${{ secrets.GENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          echo "Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          echo "Template: ${TEMPLATE_PATH}"
          echo "Output: ${OUTPUT_PATH}"

          # Primary attempt: call script with explicit flags
          # Adjust flags to match main_ai_studio_docx.py's CLI if it differs.
          python app/main_ai_studio_docx.py \
            --idea "$IDEA" \
            --model "$MODEL" \
            --template "$TEMPLATE_PATH" \
            --system-prompt "$SYSTEM_PROMPT_PATH" \
            --user-prompt "$USER_PROMPT_PATH" \
            --output "$OUTPUT_PATH" \
          || {
            echo "CLI flags may differ; retrying without flags with env vars..."
            IDEA="$IDEA" MODEL="$MODEL" TEMPLATE_PATH="$TEMPLATE_PATH" OUTPUT_PATH="$OUTPUT_PATH" \
            SYSTEM_PROMPT_PATH="$SYSTEM_PROMPT_PATH" USER_PROMPT_PATH="$USER_PROMPT_PATH" GENAI_API_KEY="$GENAI_API_KEY" \
            python app/main_ai_studio_docx.py
          }

          test -s "$OUTPUT_PATH" && echo "DOCX report generated: $OUTPUT_PATH"

      # 7) Upload artifact
      - name: Upload DOCX artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-docx
          path: ${{ env.OUTPUT_PATH }}
