name: Generate Threat Hunt Report

on:
  workflow_dispatch:
    inputs:
      topic:
        description: "Threat topic or CVE (e.g., CVE-2023-23397, Log4Shell)"
        required: true

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install google-genai

    - name: Build structured prompt
      run: |
        cat > prompt.txt << 'PROMPT'
        Generate a complete, professional threat hunting report for the following topic:

        Topic: ${{ github.event.inputs.topic }}

        Please include the following sections automatically:
        - Executive Summary
        - Threat Overview
        - CVE Details (if the topic is a CVE)
        - Attack Vector Analysis
        - Hypothesized Adversary Behavior
        - Detection Hypotheses
        - Data Sources Needed
        - Detailed Hunting Procedure
        - Detection Logic and Opportunities
        - MITRE ATT&CK Mapping
        - Indicators (IOCs/IOAs)
        - Recommendations
        - Reference Links

        PROMPT

    - name: Generate Report
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python app/main_ai_studio.py \
          --no-stream \
          --system "You are a senior threat intelligence and threat hunting analyst. Produce detailed, accurate, highly structured markdown reports." \
          --prompt-file prompt.txt \
          --output threat_hunt_report.md

    - name: Upload Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: threat-hunt-report
        path: threat_hunt_report.md
