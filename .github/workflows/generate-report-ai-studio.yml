name: Generate Threat Hunt Report

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Debug workspace (optional; helpful while stabilizing)
      - name: Debug workspace
        shell: bash
        run: |
          echo "PWD: $(pwd)"
          echo "---- top level ----"; ls -la
          echo "---- prompts ----"; ls -la prompts || true
          echo "---- output ----"; ls -la output || true

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4) Install dependencies (pin google-genai >= 1.62.0)
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            sed -i '/^google-genai/d' requirements.txt || true
            echo 'google-genai>=1.62.0' >> requirements.txt
            pip install -r requirements.txt
          else
            pip install "google-genai>=1.62.0"
          fi

      # 5) Preflight - verify both prompts & prepare attachments
      - name: Preflight - verify inputs
        shell: bash
        run: |
          set -euo pipefail
          test -f prompts/hunt_system_prompt.txt \
            || { echo "::error::prompts/hunt_system_prompt.txt NOT FOUND"; exit 1; }
          test -f prompts/hunt_user_prompt.md \
            || { echo "::error::prompts/hunt_user_prompt.md NOT FOUND"; exit 1; }

          mkdir -p output
          [[ -f output/logs.txt ]] || echo "No logs available." > output/logs.txt
          [[ -f output/findings.json ]] || echo "{}" > output/findings.json

          echo "System prompt bytes: $(wc -c < prompts/hunt_system_prompt.txt)"
          echo "User prompt bytes:   $(wc -c < prompts/hunt_user_prompt.md)"

      # 6) Run report generator (no inline workaround needed on new SDK)
      - name: Run report generator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euxo pipefail
          OUT_PATH="${{ github.workspace }}/output/threat_hunt_report.md"

          # Generate the report
          python app/main_ai_studio.py \
            --system-file prompts/hunt_system_prompt.txt \
            --prompt-file prompts/hunt_user_prompt.md \
            --attach output/logs.txt output/findings.json \
            --no-stream \
            --output "${OUT_PATH}"

          # Fallback: if the generator produced no file (or zero length), create a minimal file
          if [ ! -s "${OUT_PATH}" ]; then
            echo "::warning::Report not created or empty; creating fallback file."
            {
              echo "# Threat Hunt Report"
              echo
              echo "_No generated content was produced. Check generation logs for details (model output may have been empty)._"
              echo
              echo "## Attachments included"
              echo "- logs.txt"
              echo "- findings.json"
            } > "${OUT_PATH}"
          fi

      # 7) Verify output exists
      - name: Verify report generated
        shell: bash
        run: |
          set -euo pipefail
          ls -la output
          test -f output/threat_hunt_report.md \
            || { echo "::error::Threat hunt report NOT generated"; exit 1; }

      # 8) Upload artifact (supported v4 action)
      - name: Upload Threat Hunt Report artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report
          path: output/threat_hunt_report.md
          retention-days: 30
