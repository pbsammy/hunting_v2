name: Generate Threat Hunt Report

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-report:
    runs-on: ubuntu-latest

    # Use workflow_dispatch inputs only when that event fired; otherwise fall back to defaults
    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-1.5-pro-latest' }}

    steps:
      # 1) Checkout repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Resolve IDEA for push events (parse "idea:" from commit message)
      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            echo "IDEA already set from env."
          fi

      # 3) Setup Python (optional; keep if you want to use Python libs later)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 4) Install dependencies + show versions (optional)
      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install google-genai==1.64.0 Jinja2==3.1.4
          python -c "import importlib.metadata as m; print('google-genai:', m.version('google-genai'))"
          python -c "import importlib.metadata as m; print('Jinja2:', m.version('Jinja2'))"

      # 5) Generate report (robust: no heredoc, just printf lines)
      - name: Generate report
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}   # Uses resolved IDEA from prior step (push) or job.env (dispatch)
          MODEL: ${{ env.MODEL }}
        run: |
          set -euo pipefail
          echo "Threat Hunt Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          mkdir -p reports
          {
            printf '%s\n' '# Threat Hunt Report'
            printf '%s\n' ''
            printf '%s\n' "**Idea:** ${IDEA}"
            printf '%s\n' "**Model:** ${MODEL}"
            printf '%s\n' ''
            printf '%s\n' '## Objectives'
            printf '%s\n' '- Validate signals associated with the idea.'
            printf '%s\n' '- Enumerate data sources and relevant detections.'
            printf '%s\n' '- Identify hypotheses, gaps, and next steps.'
            printf '%s\n' ''
            printf '%s\n' '## Signals & Detections'
            printf '%s\n' '- TBD based on telemetry and threat model.'
            printf '%s\n' ''
            printf '%s\n' '## Findings'
            printf '%s\n' '- TBD.'
            printf '%s\n' ''
            printf '%s\n' '## Next Steps'
            printf '%s\n' '- TBD.'
            printf '%s\n' ''
            printf '%s\n' 'Generated by CI on GitHub Actions.'
          } > reports/threat-hunt-report.md
          test -s reports/threat-hunt-report.md && echo "Report generated OK"

      # 6) Upload artifact (optional, if you want to pull it from the run)
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report
          path: reports/threat-hunt-report.md
