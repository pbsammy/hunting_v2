name: Generate Threat Hunt Report (AI Studio DOCX)

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-docx-report:
    runs-on: ubuntu-latest

    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.model || 'gemini-1.5-pro-latest' }}
      TEMPLATE_PATH: templates/cta_hunt_report_template.md
      OUTPUT_PATH: output/threat_hunt_report.docx
      SYSTEM_PROMPT_PATH: prompts/hunt_system_prompt.txt
      USER_PROMPT_PATH: prompts/hunt_user_prompt.md

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^[[:space:]]*idea:[[:space:]]*//Ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
              echo "Resolved IDEA from commit: $PARSED"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
              echo "No 'idea:' line found in commit; using default cadence message."
            fi
          else
            echo "IDEA already set from env."
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # Optional: install system tools only if you truly convert MD -> DOCX via Pandoc.
      # If your script builds DOCX with python-docx directly, you can remove this step.
      - name: Install system dependencies (optional)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y pandoc || true

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            echo "requirements.txt found; installing..."
            pip install -r requirements.txt
          fi
          # Ensure python-docx is present even if requirements.txt missed it
          pip install --upgrade python-docx==1.1.2
          # Useful libs commonly used by AI-studio pipelines
          pip install --upgrade google-genai==1.64.0 Jinja2==3.1.4 || true
          # Import checks (YAML-safe one-liners, no heredocs)
          python -c "import sys; __import__('docx'); print('OK: docx import')"
          python -c "import sys; __import__('jinja2'); print('OK: jinja2 import')"
          # Version prints (non-fatal if not installed)
          python -c "import importlib.metadata as m; print('python-docx:', m.version('python-docx'))"
          python -c "import importlib.metadata as m; print('Jinja2:', m.version('Jinja2'))"
          python -c "import importlib.metadata as m; print('google-genai:', m.version('google-genai'))"

      - name: Validate inputs and paths
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          SYSTEM_PROMPT_PATH: ${{ env.SYSTEM_PROMPT_PATH }}
          USER_PROMPT_PATH: ${{ env.USER_PROMPT_PATH }}
        run: |
          set -euo pipefail
          [ -n "${IDEA:-}" ] || { echo "IDEA is empty; set via workflow_dispatch or commit message 'idea:'"; exit 1; }
          [ -f "$TEMPLATE_PATH" ] || { echo "Template missing: $TEMPLATE_PATH"; exit 1; }
          [ -f "$SYSTEM_PROMPT_PATH" ] || { echo "System prompt missing: $SYSTEM_PROMPT_PATH"; exit 1; }
          [ -f "$USER_PROMPT_PATH" ] || { echo "User prompt missing: $USER_PROMPT_PATH"; exit 1; }
          echo "Pre-flight OK"

      - name: Generate DOCX report (AI Studio)
        shell: bash
        env:
          IDEA: ${{ env.IDEA }}
          MODEL: ${{ env.MODEL }}
          TEMPLATE_PATH: ${{ env.TEMPLATE_PATH }}
          OUTPUT_PATH: ${{ env.OUTPUT_PATH }}
          SYSTEM_PROMPT_PATH: ${{ env.SYSTEM_PROMPT_PATH }}
          USER_PROMPT_PATH: ${{ env.USER_PROMPT_PATH }}
          GENAI_API_KEY: ${{ secrets.GENAI_API_KEY }}
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$OUTPUT_PATH")"
          echo "Idea: ${IDEA}"
          echo "Model: ${MODEL}"
          echo "Template: ${TEMPLATE_PATH}"
          echo "Output: ${OUTPUT_PATH}"

          # Primary (flags) â€” tweak names if your argparse differs
          python app/main_ai_studio_docx.py \
            --idea "$IDEA" \
            --model "$MODEL" \
            --template "$TEMPLATE_PATH" \
            --system-prompt "$SYSTEM_PROMPT_PATH" \
            --user-prompt "$USER_PROMPT_PATH" \
            --output "$OUTPUT_PATH" \
          || {
            echo "Flagged invocation failed; retrying with env-only call..."
            IDEA="$IDEA" MODEL="$MODEL" TEMPLATE_PATH="$TEMPLATE_PATH" OUTPUT_PATH="$OUTPUT_PATH" \
            SYSTEM_PROMPT_PATH="$SYSTEM_PROMPT_PATH" USER_PROMPT_PATH="$USER_PROMPT_PATH" GENAI_API_KEY="$GENAI_API_KEY" \
            python app/main_ai_studio_docx.py
          }

          test -s "$OUTPUT_PATH" && echo "DOCX report generated: $OUTPUT_PATH"

      - name: Upload DOCX artifact
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-docx
          path: ${{ env.OUTPUT_PATH }}
