name: Generate Threat Hunt Report

on:
  workflow_dispatch:
    inputs:
      idea:
        description: "Short threat-hunt idea"
        required: true
        type: string
      model:
        description: "Gemini model name (optional)"
        required: false
        type: string
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read

jobs:
  generate-report:
    runs-on: ubuntu-latest

    env:
      IDEA: ${{ github.event_name == 'workflow_dispatch' && inputs.idea || '' }}
      MODEL: ${{ github.event_name == 'workflow_dispatch' && inputs.model || 'gemini-1.5-pro-latest' }}

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve IDEA for push events
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          if [ -z "${IDEA:-}" ]; then
            COMMIT_MSG="$(git log -1 --pretty=%B)"
            PARSED="$(printf '%s\n' "$COMMIT_MSG" | sed -n 's/^idea:[[:space:]]*//ip' | head -n1)"
            if [ -n "$PARSED" ]; then
              echo "IDEA=$PARSED" >> "$GITHUB_ENV"
            else
              echo "IDEA=Hunting cadence run (no explicit idea provided)" >> "$GITHUB_ENV"
            fi
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install google-genai==1.64.0 Jinja2==3.1.4

          python - <<'PY'
import importlib.metadata as m
print("google-genai:", m.version("google-genai"))
print("Jinja2:", m.version("Jinja2"))
PY

      - name: Preflight checks
        shell: bash
        run: |
          test -f prompts/hunt_system_prompt.txt || { echo "Missing system prompt"; exit 1; }
          test -f templates/cta_hunt_report_template.md || { echo "Missing CTA markdown template"; exit 1; }
          test -f templates/CTA-reference.docx || { echo "Missing CTA Word reference document"; exit 1; }
          mkdir -p output
          [[ -f output/logs.txt ]] || echo "No logs available." > output/logs.txt
          [[ -f output/findings.json ]] || echo "{}" > output/findings.json

      - name: Run CTA Report Generator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        shell: bash
        run: |
          OUT_PATH="output/threat_hunt_report.md"

          python app/main_ai_studio.py \
            --system-file prompts/hunt_system_prompt.txt \
            --prompt "${IDEA}" \
            --attach output/logs.txt output/findings.json \
            --template templates/cta_hunt_report_template.md \
            --model "${MODEL}" \
            --output "${OUT_PATH}" \
            --min-section-words 80 \
            --strict-sections \
            --require-attack-ids

          test -f "${OUT_PATH}" || { echo "Report not generated"; exit 1; }

      - name: Convert Markdown to DOCX using CTA reference
        shell: bash
        run: |
          sudo apt-get update && sudo apt-get install -y pandoc
          pandoc output/threat_hunt_report.md \
            --reference-doc="templates/CTA-reference.docx" \
            -o output/threat_hunt_report.docx

      - name: Upload Markdown
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-md
          path: output/threat_hunt_report.md

      - name: Upload DOCX
        uses: actions/upload-artifact@v4
        with:
          name: threat-hunt-report-docx
